<head>

</head>
<script src="https://cdn.jsdelivr.net/npm/tone@14.7.77/build/Tone.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.28/build/Midi.min.js"></script>
<script src="https://unpkg.com/@tonejs/piano@0.1.3/build/Piano.js"></script>

<script defer>
    window.onload = () => {
        const inputElement = document.getElementById("input_balls");
        inputElement.addEventListener('input', function (event) {
            // The `event.target.value` property contains the current value of the input element.
            const inputValue = event.target.value;

            // The `inputValue` letiable contains the newly input character.
            // You can pass it to a callback function here.

            if (inputValue[inputValue.length - 1] != ' ') {
                blues()
            }

        });
    }


</script>



<input id="input_balls" type="text"> </input>
<input id="input" type="text" oninput="backingTrack()"> </input>


<script defer>
    let currentNoteIndex = 0;
    let direction_up = true;
    let count = 0;
    let lickIndex = 0;
    // const licks = {
    //     "F": new Array("F", "Gb", "F", "Eb", "C"),
    //     "Gb": new Array("Gb", "G", "C")
    // };

    function getNumberFromEnd(str) {
        const match = str.match(/\d+$/);
        if (match) {
            return { rawstring: str.slice(0, -match[0].length), int: parseInt(match[0]) };
        }
        return { rawstring: str, int: 0 };
    }

    const licks = {
        "F": {
            notes: ["F", "F", "Gb", "F", "Eb", "C", "Eb", "F", "Gb", "F", "Eb", "C"],
        },
        "Gb": {
            notes: ["Gb", "G", "C1", "Gb", "G", "C1", "Gb", "G", "C1", "Gb", "G", "C1"],
        },
    }

    let array = [

        'C4',
        'Eb4',
        'F4',
        'Gb4',
        'G4',
        'Bb4',
        'C5',
        'Eb5',
        'F5',
        'Gb5',
        'G5',
        'Bb5',
        'C6',
        'Eb6',
    ]

    let array_slowed = [
        "C2",
        "E2",
        "G2",
        "B2",
        "D3",
        "E3",
        "G3",
        "B3",
        "D4",
    ];


    let midi = new Midi("pls.mid");



    // define global letiables
    // array of notes

    function play(note) {
        let synth = new Tone.Synth().toMaster();
        synth.triggerAttackRelease(note, '0.1');
    }

    function blues() {
        // let synth = new Tone.Synth().toMaster();

        var finalnote;

        if (lickIndex == 0) { //we are not in the middle of a lick
            if (currentNoteIndex <= 0) direction_up = true;
            if (currentNoteIndex >= array.length - 1) direction_up = false;

            let interval = Math.floor(Math.random() * 2);

            currentNoteIndex = (direction_up) ? currentNoteIndex + interval : currentNoteIndex - interval;
            currentNote = array[currentNoteIndex];


            let octave = currentNote.substr(currentNote.length - 1, currentNote.length) //get the octave of the current note 
            let note = currentNote.slice(0, -1) // get the note of the current note

            finalNote = currentNote;

            if (note in licks && Math.random() < 0.2) { //our chosen note is in a lick and we get 60% probability of playing a lick
                lickArray = licks[note].notes;
                finalNote = lickArray[lickIndex] + octave;
                ++lickIndex;
            }

            console.log(finalNote)
            console.log(direction_up)
            console.log(interval)

        } else if (lickIndex > 0) { //we are in the middle of a lick and we do not modify currentNote

            octave = parseInt(currentNote.substr(currentNote.length - 1, currentNote.length)) //get the octave of the current note
            note = currentNote.slice(0, -1) // get the note of the current note

            lickArray = licks[note].notes;

            var obj = getNumberFromEnd(lickArray[lickIndex]);
            octave += obj.int;

            if (lickIndex >= lickArray.length - 1) {
                lickIndex = 0;
                finalNote = obj.rawstring + octave;
                currentNoteIndex = array.indexOf(finalNote);
            } else {
                finalNote = obj.rawstring + octave;
                ++lickIndex;
            }

            console.log("currently in Lick:")
            console.log(finalNote)
        }


        play(finalNote)


        ++count;
    }


    function backingTrack() {
        const synth = new Tone.PolySynth(Tone.Synth).toDestination();
        const now = Tone.now()
        synth.triggerAttack("C2", now);
        synth.triggerAttack("E2", now + 0.5);
        synth.triggerAttack("G2", now + 1);
        synth.triggerAttack("B2", now + 1.5);
        synth.triggerAttack("D3", now + 2);
    }


    function balls2() {
        const synth = new Tone.PolySynth(Tone.Synth).toDestination();

        if (currentNoteIndex <= 0) direction_up = true;
        if (currentNoteIndex >= array.length - 1) direction_up = false;

        currentNoteIndex = (direction_up) ? currentNoteIndex + 1 : currentNoteIndex - 1;

        play(array[currentNoteIndex])
    }

    function hold() {
        const synth = new Tone.PolySynth(Tone.Synth).toDestination();

        if (currentNoteIndex <= 0) direction_up = true;
        if (currentNoteIndex >= array.length - 1) direction_up = false;

        currentNoteIndex = (direction_up) ? currentNoteIndex + 1 : currentNoteIndex - 1;
        let now = Tone.now()

        console.log(array_slowed[currentNoteIndex])
        synth.triggerAttack(array_slowed[currentNoteIndex], now);

    }

    function piano() {
        const piano = new Tone.Sampler({
            urls: {
                "C4": "C4.mp3",
                "D#4": "Ds4.mp3",
                "F#4": "Fs4.mp3",
                "A4": "A4.mp3",
            },
            release: 1,
            baseUrl: "https://tonejs.github.io/audio/salamander/",
        }).toDestination();


        if (currentNoteIndex <= 0) direction_up = true;
        if (currentNoteIndex >= array.length - 1) direction_up = false;

        currentNoteIndex = (direction_up) ? currentNoteIndex + 1 : currentNoteIndex - 1;
        let now = Tone.now()

        console.log(array_slowed[currentNoteIndex])

        Tone.loaded().then(() => {
            piano.triggerAttack(["`${[array_slowed[currentNote]]}`"], 4);
        })


    }



</script>
